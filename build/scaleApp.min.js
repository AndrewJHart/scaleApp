var scaleApp=function(){return function(){var b={},h={},g={},f={},m={},e={},k={},n=function(a,c,d,i,l){var o=h[a],p,q=function(){typeof i==="function"&&i(p)};if(o){var j={};$.extend(true,j,o.opt,d);a=new b.sandbox(b,c,j);p=o.creator(a);p.opt=j;if(j.models){for(var s in j.models)j.models[s]&&x(c,s,j.models[s]());delete j.models}if(j.views){for(var v in j.views)j.views&&y(c,v,j.views[v](a));delete j.views}j.templates?z(c,j.templates,function(){delete j.templates;b.log.debug("templates loaded");q()},
function(){delete j.templates;typeof l==="function"&&l(p)}):q()}else b.log.error("could not start module '"+a+"' - module does not exist.","core")},r=function(a){if(typeof a!=="object"){b.log.error("could not register module - option has to be an object","core");return false}if(a.views){if(typeof a.views!=="object"){b.log.error("could not register module - 'views' property has to be an object","core");return false}for(var c in a.views)if(a.views[c]){if(typeof a.views[c]!=="function"){b.log.error("could not register module - the view "+
c+" is not a function","core");return false}if(typeof a.views[c](new b.sandbox(b,"dummy"))!=="object"){b.log.error("could not register module - the view "+c+" does not return an object","core");return false}}}if(a.models){if(typeof a.models!=="object"){b.log.error("could not register module - the 'models' property has to be an object","core");return false}for(var d in a.models)if(a.models[d]){c=a.models[d];if(typeof c!=="function"){b.log.error("could not register module - the model "+d+" is not a function",
"core");return false}if(typeof c(new b.sandbox(b,"dummy"))!=="object"){b.log.error("could not register module - the model "+d+" does not return an object","core");return false}}}return true},A=function(a,c,d){if(typeof a!=="string"){b.log.error("could not register module- mouduleId has to be a string","core");return false}if(typeof c!=="function"){b.log.error("could not register module - creator has to be a constructor function","core");return false}a=c();if(typeof a!=="object"||typeof a.init!=="function"||
typeof a.destroy!=="function"){b.log.error("could not register module - creator has to return an object with the functions 'init' and 'destroy'","core");return false}if(d)if(!r(d))return false;return true},w=function(a,c,d){if(typeof a==="string"&&(typeof c==="string"&&!d||typeof c==="object"&&!d||typeof c==="string"&&typeof d==="object"||!c&&!d)){if(typeof c==="object"&&!d){d=c;c=a}if(!c&&!d){c=a;d={}}return{moduleId:a,instanceId:c,opt:d}}b.log.error("could not start module '"+a+"' - illegal arguments.",
"core")},t=function(a,c,d){var i=w(a,c,d);if(i){b.log.debug("start '"+i.moduleId+"'","core");n(i.moduleId,i.instanceId,i.opt,function(l){g[i.instanceId]=l;l.init()});return true}return false},u=function(a){var c=g[a];if(c){c.destroy();delete g[a];for(var d in f[a])f[a][d]&&u(f[a][d])}else b.log.error("could not stop instance '"+a+"' - instance does not exist.","core")},x=function(a,c,d){m[a]||(m[a]={});m[a][c]=d},y=function(a,c,d){e[a]||(e[a]={});e[a][c]=d},z=function(a,c,d,i){b.log.debug("loading templates...");
var l=0,o=function(j){l--;typeof i==="function"?i(j):b.log.error("could not load template:"+j,"core");l<1&&typeof d==="function"&&d()},p=function(){b.log.debug("template loading successfull");l--;b.log.debug(l+" templates left");l<1&&typeof d==="function"&&d()},q;for(q in c){l++;B(a,q,c[q],p,o)}},B=function(a,c,d,i){k[a]||(k[a]={});var l=function(o){k[a][c]=$('<script type="text/x-jquery-tmpl">'+o+"<\/script>").template();typeof i==="function"&&i()};typeof d==="string"&&$.get(d,l)};return b={register:function(a,
c,d){if(!A(a,c,d))return false;d||(d={});h[a]={creator:c,opt:d};return true},start:t,startSubModule:function(a,c,d,i){a=w(a,c,d);if(t(a.moduleId,a.instanceId,a.opt)&&typeof i==="string"){(i=f[i])||(i=[]);i.push(a.instanceId)}},stop:u,startAll:function(){for(var a in h)h[a]&&t(a,a,h[a].opt)},stopAll:function(){for(var a in g)g.hasOwnProperty(a)&&u(a)},publish:function(a,c){for(var d in g)if(g[d].subscriptions){var i=g[d].subscriptions[a];if(i)for(var l in i)typeof i[l]==="function"&&i[l](a,c)}},subscribe:function(a,
c,d){b.log.debug("subscribe to '"+c+"'",a);a=g[a];if(!a.subscriptions)a.subscriptions={};a=a.subscriptions;a[c]||(a[c]=[]);a[c].push(d)},getModel:function(a,c){if(m[a])return m[a][c]},getView:function(a,c){if(e[a])return e[a][c]},getTemplate:function(a,c){if(k[a])return k[a][c]},getContainer:function(a){var c=g[a].opt;if(c)if(typeof c.container==="string")return $("#"+c.container);return $("#"+a)},getInstance:function(a){return g[a]},log:{debug:function(){},info:function(){},warn:function(){},error:function(){},
fatal:function(){}}}}()}();scaleApp.sandbox=function(b,h){var g=function(e,k){b.publish(e,k)},f={debug:function(e){b.log.debug(e,h)},info:function(e){b.log.info(e,h)},warn:function(e){b.log.warn(e,h)},error:function(e){b.log.error(e,h)},fatal:function(e){b.log.fatal(e,h)}},m=function(e){return b.getTemplate(h,e)};return{subscribe:function(e,k){b.subscribe(h,e,k)},unsubscribe:function(e){b.unsubscribe(h,e)},publish:g,startSubModule:function(e,k,n){b.startSubModule(e,k,n,h)},stopSubModule:function(e){b.stop(e)},getModel:function(e){return b.getModel(h,
e)},getView:function(e){return b.getView(h,e)},getTemplate:m,tmpl:function(e,k){var n=m(e);b.log.debug("tmpl","sandbox");b.log.debug(n);return $.tmpl(m(e),k)},getContainer:function(){return b.getContainer(h)},debug:f.debug,info:f.info,warn:f.warn,error:f.error,fatal:f.fatal,_:function(e){return b.i18n._(h,e)},hotkeys:function(e,k,n,r){if(typeof k==="string"){r||(r="keypress");$(document).bind(r,e,function(){g(k,n)})}else if(typeof k==="function"){n||(n="keypress");$(document).bind(n,e,k)}}}};scaleApp.log=function(){if(!console){console={};console.log=function(){};console.debug=function(){};console.info=function(){};console.warn=function(){};console.error=function(){};console.fatal=function(){}}var b={DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},h=function(g,f,m){if(m)if(typeof f==="object"){h(g,m+":");h(g,f);return}else f=m+": "+f;switch(g){case b.DEBUG:0<=b.DEBUG&&console.debug(f);break;case b.INFO:0<=b.INFO&&console.info(f);break;case b.WARN:0<=b.WARN&&console.warn(f);break;case b.ERROR:0<=
b.ERROR&&console.error(f);break;case b.FATAL:0<=b.FATAL&&console.error(f);break;default:console.log(f)}};return{debug:function(g,f){h(b.DEBUG,g,f)},info:function(g,f){h(b.INFO,g,f)},warn:function(g,f){h(b.WARN,g,f)},error:function(g,f){h(b.ERROR,g,f)},fatal:function(g,f){h(b.FATAL,g,f)}}}();scaleApp.i18n=function(b){var h=function(){return(navigator.language||navigator.browserLanguage||"en").split("-")[0]},g=h();return{setLanguage:function(f){if(typeof f==="string"){g=f;b.publish("languageChanged",f);return true}return false},getBrowserLanguage:h,getLanguage:function(){return g},_:function(f,m){var e=b.getInstance(f);if(e.opt)if(e.opt.i18n)return e.opt.i18n[g][m];return""}}}(scaleApp);
