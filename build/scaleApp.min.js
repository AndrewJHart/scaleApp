var scaleApp=function(){return function(){var b={},h={},g={},f={},e={},j={},m={},q=function(a,c,d,i,l){var n=h[a],o,p=function(){typeof i==="function"&&i(o)};if(n){var k={};$.extend(true,k,n.opt,d);a=new b.sandbox(b,c,k);o=n.creator(a);o.opt=k;if(k.models){for(var r in k.models)k.models[r]&&w(c,r,k.models[r]());delete k.models}if(k.views){for(var u in k.views)k.views&&x(c,u,k.views[u](a));delete k.views}k.templates?y(c,k.templates,function(){delete k.templates;b.log.debug("templates loaded");p()},
function(){delete k.templates;typeof l==="function"&&l(o)}):p()}else b.log.error("could not start module '"+a+"' - module does not exist.","core")},z=function(a){if(typeof a!=="object"){b.log.error("could not register module - option has to be an object","core");return false}if(a.views){if(typeof a.views!=="object"){b.log.error("could not register module - 'views' property has to be an object","core");return false}for(var c in a.views)if(a.views[c]){if(typeof a.views[c]!=="function"){b.log.error("could not register module - the view "+
c+" is not a function","core");return false}if(typeof a.views[c](new b.sandbox(b,"dummy"))!=="object"){b.log.error("could not register module - the view "+c+" does not return an object","core");return false}}}if(a.models){if(typeof a.models!=="object"){b.log.error("could not register module - the 'models' property has to be an object","core");return false}for(var d in a.models)if(a.models[d]){c=a.models[d];if(typeof c!=="function"){b.log.error("could not register module - the model "+d+" is not a function",
"core");return false}if(typeof c(new b.sandbox(b,"dummy"))!=="object"){b.log.error("could not register module - the model "+d+" does not return an object","core");return false}}}return true},A=function(a,c,d){if(typeof a!=="string"){b.log.error("could not register module- mouduleId has to be a string","core");return false}if(typeof c!=="function"){b.log.error("could not register module - creator has to be a constructor function","core");return false}a=c();if(typeof a!=="object"||typeof a.init!=="function"||
typeof a.destroy!=="function"){b.log.error("could not register module - creator has to return an object with the functions 'init' and 'destroy'","core");return false}if(d)if(!z(d))return false;return true},v=function(a,c,d){if(typeof a==="string"&&(typeof c==="string"&&!d||typeof c==="object"&&!d||typeof c==="string"&&typeof d==="object"||!c&&!d)){if(typeof c==="object"&&!d){d=c;c=a}if(!c&&!d){c=a;d={}}return{moduleId:a,instanceId:c,opt:d}}b.log.error("could not start module '"+a+"' - illegal arguments.",
"core")},s=function(a,c,d){var i=v(a,c,d);if(i){b.log.debug("start '"+i.moduleId+"'","core");q(i.moduleId,i.instanceId,i.opt,function(l){g[i.instanceId]=l;l.init()});return true}return false},t=function(a){var c=g[a];if(c){c.destroy();delete g[a];for(var d in f[a])f[a][d]&&t(f[a][d])}else b.log.error("could not stop instance '"+a+"' - instance does not exist.","core")},w=function(a,c,d){e[a]||(e[a]={});e[a][c]=d},x=function(a,c,d){j[a]||(j[a]={});j[a][c]=d},y=function(a,c,d,i){b.log.debug("loading templates...");
var l=0,n=function(k){l--;typeof i==="function"?i(k):b.log.error("could not load template:"+k,"core");l<1&&typeof d==="function"&&d()},o=function(){b.log.debug("template loading successfull");l--;b.log.debug(l+" templates left");l<1&&typeof d==="function"&&d()},p;for(p in c){l++;B(a,p,c[p],o,n)}},B=function(a,c,d,i){m[a]||(m[a]={});var l=function(n){m[a][c]=$('<script type="text/x-jquery-tmpl">'+n+"<\/script>").template();typeof i==="function"&&i()};typeof d==="string"&&$.get(d,l)};return b={register:function(a,
c,d){if(!A(a,c,d))return false;d||(d={});h[a]={creator:c,opt:d};return true},start:s,startSubModule:function(a,c,d,i){a=v(a,c,d);if(s(a.moduleId,a.instanceId,a.opt)&&typeof i==="string"){(i=f[i])||(i=[]);i.push(a.instanceId)}},stop:t,startAll:function(){for(var a in h)h[a]&&s(a,a,h[a].opt)},stopAll:function(){for(var a in g)g.hasOwnProperty(a)&&t(a)},publish:function(a,c){for(var d in g)if(g[d].subscriptions){var i=g[d].subscriptions[a];if(i)for(var l in i)typeof i[l]==="function"&&i[l](a,c)}},subscribe:function(a,
c,d){b.log.debug("subscribe to '"+c+"'",a);a=g[a];if(!a.subscriptions)a.subscriptions={};a=a.subscriptions;a[c]||(a[c]=[]);a[c].push(d)},getModel:function(a,c){if(e[a])return e[a][c]},getView:function(a,c){if(j[a])return j[a][c]},getTemplate:function(a,c){if(m[a])return m[a][c]},getInstance:function(a){return g[a]},log:{debug:function(){},info:function(){},warn:function(){},error:function(){},fatal:function(){}}}}()}();scaleApp.sandbox=function(b,h){var g=function(e,j){b.publish(e,j)},f={debug:function(e){b.log.debug(e,h)},info:function(e){b.log.info(e,h)},warn:function(e){b.log.warn(e,h)},error:function(e){b.log.error(e,h)},fatal:function(e){b.log.fatal(e,h)}};return{subscribe:function(e,j){b.subscribe(h,e,j)},unsubscribe:function(e){b.unsubscribe(h,e)},publish:g,startSubModule:function(e,j,m){b.startSubModule(e,j,m,h)},stopSubModule:function(e){b.stop(e)},getModel:function(e){return b.getModel(h,e)},getView:function(e){return b.getView(h,
e)},getTemplate:function(e){return b.getTemplate(h,e)},tmpl:function(e,j){return $.tmpl(b.getTemplate(h,e),j)},debug:f.debug,info:f.info,warn:f.warn,error:f.error,fatal:f.fatal,_:function(e){return b.i18n._(h,e)},hotkeys:function(e,j,m,q){if(typeof j==="string"){q||(q="keypress");$(document).bind(q,e,function(){g(j,m)})}else if(typeof j==="function"){m||(m="keypress");$(document).bind(m,e,j)}}}};scaleApp.log=function(){if(!console){console={};console.log=function(){};console.debug=function(){};console.info=function(){};console.warn=function(){};console.error=function(){};console.fatal=function(){}}var b={DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},h=function(g,f,e){if(e)if(typeof f==="object"){h(g,e+":");h(g,f);return}else f=e+": "+f;switch(g){case b.DEBUG:0<=b.DEBUG&&console.debug(f);break;case b.INFO:0<=b.INFO&&console.info(f);break;case b.WARN:0<=b.WARN&&console.warn(f);break;case b.ERROR:0<=
b.ERROR&&console.error(f);break;case b.FATAL:0<=b.FATAL&&console.error(f);break;default:console.log(f)}};return{debug:function(g,f){h(b.DEBUG,g,f)},info:function(g,f){h(b.INFO,g,f)},warn:function(g,f){h(b.WARN,g,f)},error:function(g,f){h(b.ERROR,g,f)},fatal:function(g,f){h(b.FATAL,g,f)}}}();scaleApp.i18n=function(b){var h=function(){return(navigator.language||navigator.browserLanguage||"en").split("-")[0]},g=h();return{setLanguage:function(f){if(typeof f==="string"){g=f;b.publish("languageChanged",f);return true}return false},getBrowserLanguage:h,getLanguage:function(){return g},_:function(f,e){var j=b.getInstance(f);if(j.opt)if(j.opt.i18n)return j.opt.i18n[g][e];return""}}}(scaleApp);
