var scaleApp=function(){return function(){var d={},i={},g={},f={},m={},e={},k={},n=function(a,b,c,h,l){var o=i[a],p,q=function(){typeof h==="function"&&h(p)};if(o){var j={};$.extend(true,j,o.opt,c);a=new d.sandbox(d,b,j);p=o.creator(a);p.opt=j;if(j.models){for(var s in j.models)j.models[s]&&x(b,s,j.models[s]());delete j.models}if(j.views){for(var v in j.views)j.views&&y(b,v,j.views[v](a));delete j.views}j.templates?z(b,j.templates,function(){delete j.templates;d.log.debug("templates loaded");q()},
function(){delete j.templates;typeof l==="function"&&l(p)}):q()}else d.log.error("could not start module '"+a+"' - module does not exist.","core")},r=function(a){if(typeof a!=="object"){d.log.error("could not register module - option has to be an object","core");return false}if(a.views){if(typeof a.views!=="object"){d.log.error("could not register module - 'views' property has to be an object","core");return false}for(var b in a.views)if(a.views[b]){if(typeof a.views[b]!=="function"){d.log.error("could not register module - the view "+
b+" is not a function","core");return false}if(typeof a.views[b](new d.sandbox(d,"dummy"))!=="object"){d.log.error("could not register module - the view "+b+" does not return an object","core");return false}}}if(a.models){if(typeof a.models!=="object"){d.log.error("could not register module - the 'models' property has to be an object","core");return false}for(var c in a.models)if(a.models[c]){b=a.models[c];if(typeof b!=="function"){d.log.error("could not register module - the model "+c+" is not a function",
"core");return false}if(typeof b(new d.sandbox(d,"dummy"))!=="object"){d.log.error("could not register module - the model "+c+" does not return an object","core");return false}}}return true},A=function(a,b,c){if(typeof a!=="string"){d.log.error("could not register module- mouduleId has to be a string","core");return false}if(typeof b!=="function"){d.log.error("could not register module - creator has to be a constructor function","core");return false}a=b();if(typeof a!=="object"||typeof a.init!=="function"||
typeof a.destroy!=="function"){d.log.error("could not register module - creator has to return an object with the functions 'init' and 'destroy'","core");return false}if(c)if(!r(c))return false;return true},w=function(a,b,c){if(typeof a==="string"&&(typeof b==="string"&&!c||typeof b==="object"&&!c||typeof b==="string"&&typeof c==="object"||!b&&!c)){if(typeof b==="object"&&!c){c=b;b=a}if(!b&&!c){b=a;c={}}return{moduleId:a,instanceId:b,opt:c}}d.log.error("could not start module '"+a+"' - illegal arguments.",
"core")},t=function(a,b,c){var h=w(a,b,c);if(h){d.log.debug("start '"+h.moduleId+"'","core");n(h.moduleId,h.instanceId,h.opt,function(l){g[h.instanceId]=l;l.init()});return true}return false},u=function(a){var b=g[a];if(b){b.destroy();delete g[a];for(var c in f[a])f[a][c]&&u(f[a][c])}else d.log.error("could not stop instance '"+a+"' - instance does not exist.","core")},x=function(a,b,c){m[a]||(m[a]={});m[a][b]=c},y=function(a,b,c){e[a]||(e[a]={});e[a][b]=c},z=function(a,b,c,h){d.log.debug("loading templates...");
var l=0,o=function(j){l--;typeof h==="function"?h(j):d.log.error("could not load template:"+j,"core");l<1&&typeof c==="function"&&c()},p=function(){d.log.debug("template loading successfull");l--;d.log.debug(l+" templates left");l<1&&typeof c==="function"&&c()},q;for(q in b){l++;B(a,q,b[q],p,o)}},B=function(a,b,c,h){k[a]||(k[a]={});var l=function(o){k[a][b]=$('<script type="text/x-jquery-tmpl">'+o+"<\/script>").template();typeof h==="function"&&h()};typeof c==="string"&&$.get(c,l)};return d={register:function(a,
b,c){if(!A(a,b,c))return false;c||(c={});i[a]={creator:b,opt:c};return true},start:t,startSubModule:function(a,b,c,h){a=w(a,b,c);if(t(a.moduleId,a.instanceId,a.opt)&&typeof h==="string"){(h=f[h])||(h=[]);h.push(a.instanceId)}},stop:u,startAll:function(){for(var a in i)i[a]&&t(a,a,i[a].opt)},stopAll:function(){for(var a in g)g.hasOwnProperty(a)&&u(a)},publish:function(a,b){for(var c in g)if(g[c].subscriptions){var h=g[c].subscriptions[a];if(h)for(var l in h)typeof h[l]==="function"&&h[l](a,b)}},subscribe:function(a,
b,c){d.log.debug("subscribe to '"+b+"'",a);a=g[a];if(!a.subscriptions)a.subscriptions={};a=a.subscriptions;a[b]||(a[b]=[]);a[b].push(c)},getModel:function(a,b){var c=m[a];if(c){if(!b&&$(c).length==1){for(var h in c)break;return c[h]}return c[b]}},getView:function(a,b){var c=e[a];if(c){if(!b&&$(c).length==1){for(var h in c)break;return c[h]}return c[b]}},getTemplate:function(a,b){var c=k[a];if(c){if(!b&&$(c).length==1){for(var h in c)break;return c[h]}return c[b]}},getContainer:function(a){var b=g[a].opt;
if(b)if(typeof b.container==="string")return $("#"+b.container);return $("#"+a)},getInstance:function(a){return g[a]},log:{debug:function(){},info:function(){},warn:function(){},error:function(){},fatal:function(){}}}}()}();scaleApp.sandbox=function(d,i){var g=function(e,k){d.publish(e,k)},f={debug:function(e){d.log.debug(e,i)},info:function(e){d.log.info(e,i)},warn:function(e){d.log.warn(e,i)},error:function(e){d.log.error(e,i)},fatal:function(e){d.log.fatal(e,i)}},m=function(e){return d.getTemplate(i,e)};return{subscribe:function(e,k){d.subscribe(i,e,k)},unsubscribe:function(e){d.unsubscribe(i,e)},publish:g,startSubModule:function(e,k,n){d.startSubModule(e,k,n,i)},stopSubModule:function(e){d.stop(e)},getModel:function(e){return d.getModel(i,
e)},getView:function(e){return d.getView(i,e)},getTemplate:m,tmpl:function(e,k){return $.tmpl(m(e),k)},getContainer:function(){return d.getContainer(i)},debug:f.debug,info:f.info,warn:f.warn,error:f.error,fatal:f.fatal,_:function(e){return d.i18n._(i,e)},hotkeys:function(e,k,n,r){if(typeof k==="string"){r||(r="keypress");$(document).bind(r,e,function(){g(k,n)})}else if(typeof k==="function"){n||(n="keypress");$(document).bind(n,e,k)}}}};scaleApp.log=function(){if(!console){console={};console.log=function(){};console.debug=function(){};console.info=function(){};console.warn=function(){};console.error=function(){};console.fatal=function(){}}var d={DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},i=function(g,f,m){if(m)if(typeof f==="object"){i(g,m+":");i(g,f);return}else f=m+": "+f;switch(g){case d.DEBUG:0<=d.DEBUG&&console.debug(f);break;case d.INFO:0<=d.INFO&&console.info(f);break;case d.WARN:0<=d.WARN&&console.warn(f);break;case d.ERROR:0<=
d.ERROR&&console.error(f);break;case d.FATAL:0<=d.FATAL&&console.error(f);break;default:console.log(f)}};return{debug:function(g,f){i(d.DEBUG,g,f)},info:function(g,f){i(d.INFO,g,f)},warn:function(g,f){i(d.WARN,g,f)},error:function(g,f){i(d.ERROR,g,f)},fatal:function(g,f){i(d.FATAL,g,f)}}}();scaleApp.i18n=function(d){var i=function(){return(navigator.language||navigator.browserLanguage||"en").split("-")[0]},g=i();return{setLanguage:function(f){if(typeof f==="string"){g=f;d.publish("languageChanged",f);return true}return false},getBrowserLanguage:i,getLanguage:function(){return g},_:function(f,m){var e=d.getInstance(f);if(e.opt)if(e.opt.i18n)return e.opt.i18n[g][m];return""}}}(scaleApp);
